


<h1><a name="ragdoll_physics" id="ragdoll_physics">Ragdoll Physics</a></h1>
<div class="level1">

<p>

The jMonkeyEngine3 has built-in support for <object classid="java:org.netbeans.modules.javahelp.BrowserDisplayer"><param name="content" value="http://jbullet.advel.cz"><param name="text" value="<html><u>hinges and joints</u></html>"><param name="textColor" value="blue"></object> possible. One special example of physical joints are ragdoll physics.
</p>

</div>
<!-- SECTION "Ragdoll Physics" [1-339] -->
<h2><a name="sample_code" id="sample_code">Sample Code</a></h2>
<div class="level2">
<ul>
<li class="level1"><div class="li"> <object classid="java:org.netbeans.modules.javahelp.BrowserDisplayer"><param name="content" value="http://code.google.com/p/jmonkeyengine/source/browse/branches/jme3/src/test/jme3test/bullet/TestRagDoll.java"><param name="text" value="<html><u>TestRagDoll.java</u></html>"><param name="textColor" value="blue"></object> (click to pull the ragdoll up)</div>
</li>
</ul>

</div>
<!-- SECTION "Sample Code" [340-530] -->
<h2><a name="preparing_the_physics_game" id="preparing_the_physics_game">Preparing the Physics Game</a></h2>
<div class="level2">
<ol>
<li class="level1"><div class="li"> Create a SimpleApplication with a <a href="/com/jme3/gde/core/docs/jme3/advanced/physics.html" class="wikilink1" title="jme3:advanced:physics">BulletAppState</a> </div>
<ul>
<li class="level2"><div class="li"> This gives us a PhysicsSpace for PhysicsNodes</div>
</li>
</ul>
</li>
<li class="level1"><div class="li"> Add a physical floor (A box collision shape with mass zero)</div>
</li>
</ol>

</div>
<!-- SECTION "Preparing the Physics Game" [531-769] -->
<h2><a name="creating_the_ragdoll" id="creating_the_ragdoll">Creating the Ragdoll</a></h2>
<div class="level2">

<p>

<img src="nbdocs:/com/jme3/gde/core/docs/jme3/advanced/ragdoll.png">
</p>

<p>
The ragdoll is a simple dummy that we build out of cylinder collision shapes. It has 11 limbs: shoulders, a body, and hips; plus 2 arms and 2 legs are made up of two limbs each.
</p>

</div>
<!-- SECTION "Creating the Ragdoll" [770-1023] -->
<h3><a name="limbs" id="limbs">Limbs</a></h3>
<div class="level3">

<p>
Since we&#039;re just creating the ragdoll for this example, all the limbs have the same shape, and we can write a simple helper method to create them. The function returns a PhysicsNode with CollisionShape with the width, height, location, and rotation (vertical or horizontal) that we specify. We choose a CapsuleCollisionShape (a cylinder with rounded top and bottom) so the limbs collide smoothly against one another.
</p>
<pre class="code java">    <span class="kw1">private</span> PhysicsNode createLimb<span class="br0">&#40;</span> <span class="kw4">float</span> width, <span class="kw4">float</span> height, 
                                    Vector3f location, <span class="kw4">boolean</span> rotate<span class="br0">&#41;</span> <span class="br0">&#123;</span>
        <span class="kw4">int</span> axis <span class="sy0">=</span> rotate <span class="sy0">?</span> PhysicsSpace.<span class="me1">AXIS_X</span> <span class="sy0">:</span> PhysicsSpace.<span class="me1">AXIS_Y</span>;
        CapsuleCollisionShape shape <span class="sy0">=</span> <span class="kw1">new</span> CapsuleCollisionShape<span class="br0">&#40;</span>width, height, axis<span class="br0">&#41;</span>;
        PhysicsNode node <span class="sy0">=</span> <span class="kw1">new</span> PhysicsNode<span class="br0">&#40;</span>shape<span class="br0">&#41;</span>;
        node.<span class="me1">attachDebugShape</span><span class="br0">&#40;</span>assetManager<span class="br0">&#41;</span>;
        node.<span class="me1">setLocalTranslation</span><span class="br0">&#40;</span>location<span class="br0">&#41;</span>;
        <span class="kw1">return</span> node;
    <span class="br0">&#125;</span></pre>
<p>
We use the helper method to initialize the 11 limbs. 
</p>
<ul>
<li class="level1"><div class="li"> All cylinders have the same diameter, 0.2f.</div>
</li>
<li class="level1"><div class="li"> We make the body and shoulders longer than the other limbs, 1.0f instead of 0.5f.</div>
</li>
<li class="level1"><div class="li"> We determine the coordinates for positioning the limbs to form a person.</div>
</li>
<li class="level1"><div class="li"> The shoulders and hips are vertical cylinders, this is why we set the rotation to true.</div>
</li>
</ul>
<pre class="code java">        PhysicsNode shoulders <span class="sy0">=</span> createLimb<span class="br0">&#40;</span>0.2f, 1.0f, <span class="kw1">new</span> Vector3f<span class="br0">&#40;</span> 0.00f, 1.5f, 0<span class="br0">&#41;</span>, <span class="kw2">true</span><span class="br0">&#41;</span>;
        PhysicsNode uArmL     <span class="sy0">=</span> createLimb<span class="br0">&#40;</span>0.2f, 0.5f, <span class="kw1">new</span> Vector3f<span class="br0">&#40;</span><span class="sy0">-</span>0.75f, 0.8f, 0<span class="br0">&#41;</span>, <span class="kw2">false</span><span class="br0">&#41;</span>;
        PhysicsNode uArmR     <span class="sy0">=</span> createLimb<span class="br0">&#40;</span>0.2f, 0.5f, <span class="kw1">new</span> Vector3f<span class="br0">&#40;</span> 0.75f, 0.8f, 0<span class="br0">&#41;</span>, <span class="kw2">false</span><span class="br0">&#41;</span>;
        PhysicsNode lArmL     <span class="sy0">=</span> createLimb<span class="br0">&#40;</span>0.2f, 0.5f, <span class="kw1">new</span> Vector3f<span class="br0">&#40;</span><span class="sy0">-</span>0.75f,<span class="sy0">-</span>0.2f, 0<span class="br0">&#41;</span>, <span class="kw2">false</span><span class="br0">&#41;</span>;
        PhysicsNode lArmR     <span class="sy0">=</span> createLimb<span class="br0">&#40;</span>0.2f, 0.5f, <span class="kw1">new</span> Vector3f<span class="br0">&#40;</span> 0.75f,<span class="sy0">-</span>0.2f, 0<span class="br0">&#41;</span>, <span class="kw2">false</span><span class="br0">&#41;</span>;
        PhysicsNode body      <span class="sy0">=</span> createLimb<span class="br0">&#40;</span>0.2f, 1.0f, <span class="kw1">new</span> Vector3f<span class="br0">&#40;</span> 0.00f, 0.5f, 0<span class="br0">&#41;</span>, <span class="kw2">false</span><span class="br0">&#41;</span>;
        PhysicsNode hips      <span class="sy0">=</span> createLimb<span class="br0">&#40;</span>0.2f, 0.5f, <span class="kw1">new</span> Vector3f<span class="br0">&#40;</span> 0.00f,<span class="sy0">-</span>0.5f, 0<span class="br0">&#41;</span>, <span class="kw2">true</span><span class="br0">&#41;</span>;
        PhysicsNode uLegL     <span class="sy0">=</span> createLimb<span class="br0">&#40;</span>0.2f, 0.5f, <span class="kw1">new</span> Vector3f<span class="br0">&#40;</span><span class="sy0">-</span>0.25f,<span class="sy0">-</span>1.2f, 0<span class="br0">&#41;</span>, <span class="kw2">false</span><span class="br0">&#41;</span>;
        PhysicsNode uLegR     <span class="sy0">=</span> createLimb<span class="br0">&#40;</span>0.2f, 0.5f, <span class="kw1">new</span> Vector3f<span class="br0">&#40;</span> 0.25f,<span class="sy0">-</span>1.2f, 0<span class="br0">&#41;</span>, <span class="kw2">false</span><span class="br0">&#41;</span>;
        PhysicsNode lLegL     <span class="sy0">=</span> createLimb<span class="br0">&#40;</span>0.2f, 0.5f, <span class="kw1">new</span> Vector3f<span class="br0">&#40;</span><span class="sy0">-</span>0.25f,<span class="sy0">-</span>2.2f, 0<span class="br0">&#41;</span>, <span class="kw2">false</span><span class="br0">&#41;</span>;
        PhysicsNode lLegR     <span class="sy0">=</span> createLimb<span class="br0">&#40;</span>0.2f, 0.5f, <span class="kw1">new</span> Vector3f<span class="br0">&#40;</span> 0.25f,<span class="sy0">-</span>2.2f, 0<span class="br0">&#41;</span>, <span class="kw2">false</span><span class="br0">&#41;</span>;</pre>
<p>
We now have the outline of a person, but if we ran the application now, the individual limbs would fall down independently of one another – the ragdoll is still lacking joints.
</p>

</div>
<!-- SECTION "Limbs" [1024-3531] -->
<h3><a name="joints" id="joints">Joints</a></h3>
<div class="level3">

<p>

As before, we write a small helper method. This time its purpose is to quickly join two limbs A and B at the connection point that we specify. 
</p>
<ul>
<li class="level1"><div class="li"> We convert A&#039;s and B&#039;s connectionPoint vector from world coordinate space to local coordinate space.</div>
</li>
<li class="level1"><div class="li"> We use a PhysicsConeJoint, a special joint that approximates the degree of freedom that limbs typically have. It requires the two nodes, and the local pivot coordinates that we just determined.</div>
</li>
<li class="level1"><div class="li">  We set the joints limits to allow swinging, but not twisting.</div>
</li>
</ul>
<pre class="code java">    <span class="kw1">private</span> PhysicsJoint join<span class="br0">&#40;</span>PhysicsNode A, PhysicsNode B, Vector3f connectionPoint<span class="br0">&#41;</span> <span class="br0">&#123;</span>
        Vector3f pivotA <span class="sy0">=</span> A.<span class="me1">worldToLocal</span><span class="br0">&#40;</span>connectionPoint, <span class="kw1">new</span> Vector3f<span class="br0">&#40;</span><span class="br0">&#41;</span><span class="br0">&#41;</span>;
        Vector3f pivotB <span class="sy0">=</span> B.<span class="me1">worldToLocal</span><span class="br0">&#40;</span>connectionPoint, <span class="kw1">new</span> Vector3f<span class="br0">&#40;</span><span class="br0">&#41;</span><span class="br0">&#41;</span>;
        PhysicsConeJoint joint <span class="sy0">=</span> <span class="kw1">new</span> PhysicsConeJoint<span class="br0">&#40;</span>A, B, pivotA, pivotB<span class="br0">&#41;</span>;
        joint.<span class="me1">setLimit</span><span class="br0">&#40;</span>1f, 1f, 0<span class="br0">&#41;</span>;
        <span class="kw1">return</span> joint;
    <span class="br0">&#125;</span></pre>
<p>
We use the helper method to connect all limbs with joints where they belong, at one end of the limb. 
</p>
<pre class="code java">        join<span class="br0">&#40;</span>body,  shoulders, <span class="kw1">new</span> Vector3f<span class="br0">&#40;</span>0f,  1.4f, 0<span class="br0">&#41;</span><span class="br0">&#41;</span>;
        join<span class="br0">&#40;</span>body,  hips,      <span class="kw1">new</span> Vector3f<span class="br0">&#40;</span>0f, <span class="sy0">-</span>0.5f, 0<span class="br0">&#41;</span><span class="br0">&#41;</span>;
&nbsp;
        join<span class="br0">&#40;</span>uArmL, shoulders, <span class="kw1">new</span> Vector3f<span class="br0">&#40;</span><span class="sy0">-</span>0.75f, 1.4f, 0<span class="br0">&#41;</span><span class="br0">&#41;</span>;
        join<span class="br0">&#40;</span>uArmR, shoulders, <span class="kw1">new</span> Vector3f<span class="br0">&#40;</span> 0.75f, 1.4f, 0<span class="br0">&#41;</span><span class="br0">&#41;</span>;
        join<span class="br0">&#40;</span>uArmL, lArmL,     <span class="kw1">new</span> Vector3f<span class="br0">&#40;</span><span class="sy0">-</span>0.75f, 0.4f, 0<span class="br0">&#41;</span><span class="br0">&#41;</span>;
        join<span class="br0">&#40;</span>uArmR, lArmR,     <span class="kw1">new</span> Vector3f<span class="br0">&#40;</span> 0.75f, 0.4f, 0<span class="br0">&#41;</span><span class="br0">&#41;</span>;
&nbsp;
        join<span class="br0">&#40;</span>uLegL, hips,  <span class="kw1">new</span> Vector3f<span class="br0">&#40;</span><span class="sy0">-</span>.25f, <span class="sy0">-</span>0.5f, 0<span class="br0">&#41;</span><span class="br0">&#41;</span>;
        join<span class="br0">&#40;</span>uLegR, hips,  <span class="kw1">new</span> Vector3f<span class="br0">&#40;</span> .25f, <span class="sy0">-</span>0.5f, 0<span class="br0">&#41;</span><span class="br0">&#41;</span>;
        join<span class="br0">&#40;</span>uLegL, lLegL, <span class="kw1">new</span> Vector3f<span class="br0">&#40;</span><span class="sy0">-</span>.25f, <span class="sy0">-</span>1.7f, 0<span class="br0">&#41;</span><span class="br0">&#41;</span>;
        join<span class="br0">&#40;</span>uLegR, lLegR, <span class="kw1">new</span> Vector3f<span class="br0">&#40;</span> .25f, <span class="sy0">-</span>1.7f, 0<span class="br0">&#41;</span><span class="br0">&#41;</span>;</pre>
<p>
Now the ragdoll is connected. If we ran the app now, the doll would collapse, but the limbs would stay together.
</p>

</div>
<!-- SECTION "Joints" [3532-5311] -->
<h3><a name="attaching_everything_to_the_scene" id="attaching_everything_to_the_scene">Attaching Everything to the Scene</a></h3>
<div class="level3">

<p>

We create one main (non-physical) Node named ragDoll. 
</p>
<pre class="code java">        ragDoll.<span class="me1">attachChild</span><span class="br0">&#40;</span>shoulders<span class="br0">&#41;</span>;
        ragDoll.<span class="me1">attachChild</span><span class="br0">&#40;</span>body<span class="br0">&#41;</span>;
        ragDoll.<span class="me1">attachChild</span><span class="br0">&#40;</span>hips<span class="br0">&#41;</span>;
        ragDoll.<span class="me1">attachChild</span><span class="br0">&#40;</span>uArmL<span class="br0">&#41;</span>;
        ragDoll.<span class="me1">attachChild</span><span class="br0">&#40;</span>uArmR<span class="br0">&#41;</span>;
        ragDoll.<span class="me1">attachChild</span><span class="br0">&#40;</span>lArmL<span class="br0">&#41;</span>;
        ragDoll.<span class="me1">attachChild</span><span class="br0">&#40;</span>lArmR<span class="br0">&#41;</span>;
        ragDoll.<span class="me1">attachChild</span><span class="br0">&#40;</span>uLegL<span class="br0">&#41;</span>;
        ragDoll.<span class="me1">attachChild</span><span class="br0">&#40;</span>uLegR<span class="br0">&#41;</span>;
        ragDoll.<span class="me1">attachChild</span><span class="br0">&#40;</span>lLegL<span class="br0">&#41;</span>;
        ragDoll.<span class="me1">attachChild</span><span class="br0">&#40;</span>lLegR<span class="br0">&#41;</span>;</pre>
<p>
To use the ragdoll, we attach its main node to the rootNode and to the PhysicsSpace.
</p>
<pre class="code java">        rootNode.<span class="me1">attachChild</span><span class="br0">&#40;</span>ragDoll<span class="br0">&#41;</span>;
        bulletAppState.<span class="me1">getPhysicsSpace</span><span class="br0">&#40;</span><span class="br0">&#41;</span>.<span class="me1">addAll</span><span class="br0">&#40;</span>ragDoll<span class="br0">&#41;</span>;</pre>
</div>
<!-- SECTION "Attaching Everything to the Scene" [5312-6035] -->
<h2><a name="applying_forces" id="applying_forces">Applying Forces</a></h2>
<div class="level2">

<p>

To pull the doll up, you could add an input handler that triggers the following action: 
</p>
<pre class="code java">Vector3f upforce <span class="sy0">=</span> <span class="kw1">new</span> Vector3f<span class="br0">&#40;</span>0, <span class="nu0">200</span>, 0<span class="br0">&#41;</span>;
shoulders.<span class="me1">applyContinuousForce</span><span class="br0">&#40;</span><span class="kw2">true</span>, upforce<span class="br0">&#41;</span>;</pre>
<p>
We can use the action to pick the doll up and put it back on its feet, or what ever. Read more about <a href="/com/jme3/gde/core/docs/jme3/advanced/physics#forcesmoving_physical_objects.html" class="wikilink1" title="jme3:advanced:physics">Forces</a> here.
</p>

</div>
<!-- SECTION "Applying Forces" [6036-6438] -->
<h2><a name="detecting_collisions" id="detecting_collisions">Detecting Collisions</a></h2>
<div class="level2">

<p>

Read the <a href="/com/jme3/gde/core/docs/jme3/advanced/physics#responding_to_a_physicscollisionevent.html" class="wikilink1" title="jme3:advanced:physics">Responding to a PhysicsCollisionEvent</a> chapter in the general physics documentation on how to detect collisions.
</p>

</div>
<!-- SECTION "Detecting Collisions" [6439-6659] -->
<h2><a name="best_practices" id="best_practices">Best Practices</a></h2>
<div class="level2">

<p>

If you are seeing weird behaviour in a ragdoll – such as exploding into pieces and then reassembling – check your collision shapes. Verify you did not position the limbs too close to one another when assmebling the ragdoll. You typically see physical nodes being ejected when their collision shapes intersect, which puts physics in an impossible state. 
</p>

</div>
<!-- SECTION "Best Practices" [6660-] -->
<p><em><a href="http://jmonkeyengine.org/wiki/doku.php/jme3:advanced:ragdoll?do=export_xhtmlbody">view online version</a></em></p>